<as4-box title="Filters" collapsible="true">
    <div content>
        <as4-filter #filter [filter]="messageFilter">
            <div class="col-md-6 col-xs-12">
                <as4-input label="Direction" labelSize="3" controlSize="9">
                    <div class="input-group">
                        <select [(ngModel)]="filter.filter.direction" multiselect>
                            <option value="0" selected>Inbound</option>
                            <option value="1" selected>Outbound</option>
                        </select>
                        <span class="input-group-btn">
                            <button class="btn btn-secondary" type="button" (click)="filter.filter.direction = null"><i class="fa fa-trash"></i></button>
                        </span>
                    </div>
                </as4-input>
                <as4-input label="Operation" labelSize="3" controlSize="9">
                    <div class="input-group">
                        <select name="operation" [(ngModel)]="filter.filter.operation" multiselect>
                            <option value="0">Not applicable</option>
                            <option value="1">Undetermined</option>
                            <option value="2">To be sent</option>
                            <option value="3">Sending</option>
                            <option value="4">Sent</option>
                            <option value="5">Dead lettered</option>
                            <option value="6">To be notified</option>
                            <option value="7">Notifying</option>
                            <option value="8">Notified</option>
                            <option value="9">To be delivered</option>
                            <option value="10">Delivering</option>
                            <option value="11">Delivered</option>
                        </select>
                        <span class="input-group-btn">
                            <button class="btn btn-secondary" type="button" (click)="filter.filter.operation = null"><i class="fa fa-trash"></i></button>
                        </span>
                    </div>
                </as4-input>
                <as4-input label="ebMS message id" labelSize="3" controlSize="9">
                    <div class="input-group">
                        <input type="text" name="ebmsMessageId" [(ngModel)]="filter.filter.ebmsMessageId" />
                        <div class="input-group-btn">
                            <button class="btn btn-secondary" type="button" (click)="switchIds()"><i class="fa fa-rotate-90 fa-exchange"></i></button>
                        </div>
                    </div>
                </as4-input>
                <as4-input label="ebMS ref to message id" labelSize="3" controlSize="9">
                    <div class="input-group">
                        <input type="text" name="ebmsRefToMessageId" [(ngModel)]="filter.filter.ebmsRefToMessageId" />
                        <div class="input-group-btn">
                            <button class="btn btn-secondary" type="button" (click)="switchIds()"><i class="fa fa-rotate-90 fa-exchange"></i></button>
                        </div>
                    </div>
                </as4-input>
                <as4-input label="ebMS message type" labelSize="3" controlSize="9">
                    <div class="input-group">
                        <select name="ebmsMessageType" [(ngModel)]="filter.filter.ebmsMessageType" multiselect>
                            <option value="0">User message</option>
                            <option value="1">Exception</option>
                            <option value="2">Receipt</option>
                        </select>
                        <span class="input-group-btn">
                            <button class="btn btn-secondary" type="button" (click)="filter.filter.ebmsMessageType = null"><i class="fa fa-trash"></i></button>
                        </span>
                    </div>
                </as4-input>
                <as4-input label="From party" labelSize="3" controlSize="9">
                    <input type="text" name="fromParty" [(ngModel)]="filter.filter.fromParty" />
                </as4-input>
                <as4-input label="To party" labelSize="3" controlSize="9">
                    <input type="text" name="toParty" [(ngModel)]="filter.filter.toParty" />
                </as4-input>
            </div>
            <div class="col-md-6 col-xs-12">
                <as4-input label="Message exchange pattern" labelSize="3" controlSize="9">
                    <div class="input-group">
                        <select name="MEP" [(ngModel)]="filter.filter.mep" multiselect>
                            <option value="0">Push</option>
                            <option value="1">Pull</option>
                        </select>
                        <span class="input-group-btn">
                            <button class="btn btn-secondary" type="button" (click)="filter.filter.mep = null"><i class="fa fa-trash"></i></button>
                        </span>
                    </div>
                </as4-input>
                <as4-input label="Content type" labelSize="3" controlSize="9">
                    <div class="input-group">
                        <select name="contentType" [(ngModel)]="filter.filter.contentType" multiselect>
                            <option value="xml">Xml</option>
                            <option value="mime">Mime</option>
                        </select>
                        <span class="input-group-btn">
                            <button class="btn btn-secondary" type="button" (click)="filter.filter.contentType = null"><i class="fa fa-trash"></i></button>
                        </span>
                    </div>
                </as4-input>
                <as4-input label="Status" labelSize="3" controlSize="9">
                    <div class="input-group">
                        <select name="status" [(ngModel)]="filter.filter.status" multiselect>
                            <option value="0">Received</option>
                            <option value="1">Delivered</option>
                            <option value="2">Created</option>
                            <option value="3">Notified</option>
                            <option value="4">Exception</option>
                            <option value="5">Not applicable</option>
                            <option value="6">Submitted</option>
                            <option value="7">Nack</option>
                            <option value="8">Sent</option>
                        </select>
                        <span class="input-group-btn">
                            <button class="btn btn-secondary" type="button" (click)="filter.filter.status = null"><i class="fa fa-trash"></i></button>
                        </span>
                    </div>
                </as4-input>
                <as4-input label="Modification time" labelSize="3" controlSize="9">
                    <div class="row time-range">
                        <div class="col-xs-12 col-md-5">
                            <div class="input-group">
                                <input placeholder="From" class="col-xs-10" type="text" as4-datetimepicker [(ngModel)]="filter.filter.modificationTimeFrom"
                                />
                                <span class="input-group-btn">
                                    <button type="button" class="btn btn-secondary" (click)="filter.filter.modificationTimeFrom = null"><i class="fa fa-trash"></i></button>
                                </span>
                            </div>
                        </div>
                        <div class="col-xs-12 col-md-2 text-center">to</div>
                        <div class="col-xs-12 col-md-5">
                            <div class="input-group">
                                <input placeholder="To" type="text" as4-datetimepicker [(ngModel)]="filter.filter.modificationTimeTo" />
                                <span class="input-group-btn">
                                    <button type="button" class="btn btn-secondary" (click)="filter.filter.modificationTimeTo = null"><i class="fa fa-trash"></i></button>
                                </span>
                            </div>
                        </div>
                    </div>
                </as4-input>
                <as4-input label="Insertion time" labelSize="3" controlSize="9">
                    <div class="row time-range">
                        <div class="col-xs-12 col-md-5">
                            <div class="input-group">
                                <input placeholder="From" class="col-xs-10" type="text" as4-datetimepicker [(ngModel)]="filter.filter.insertionTimeFrom"
                                />
                                <span class="input-group-btn">
                                    <button type="button" class="btn btn-secondary" (click)="filter.filter.insertionTimeFrom = null"><i class="fa fa-trash"></i></button>
                                </span>
                            </div>
                        </div>
                        <div class="col-xs-12 col-md-2 text-center">to</div>
                        <div class="col-xs-12 col-md-5">
                            <div class="input-group">
                                <input placeholder="To" type="text" as4-datetimepicker [(ngModel)]="filter.filter.insertionTimeTo" />
                                <span class="input-group-btn">
                                    <button type="button" class="btn btn-secondary" (click)="filter.filter.insertionTimeTo = null"><i class="fa fa-trash"></i></button>
                                </span>
                            </div>
                        </div>
                    </div>
                </as4-input>
                <as4-input label="Show duplicates" labelSize="3" controlSize="9">
                    <input type="checkbox" [(ngModel)]="filter.filter.showDuplicates" />
                </as4-input>
                <as4-input label="Show tests" labelSize="3" controlSize="9">
                    <input type="checkbox" [(ngModel)]="filter.filter.showTests" />
                </as4-input>
                <as4-input controlSize="12" [showLabel]="false">
                    <button type="submit" class="btn btn-default pull-right"><i class="fa fa-search"></i></button>
                </as4-input>
            </div>
        </as4-filter>
    </div>
</as4-box>
<as4-box title="Messages">
    <div content *ngIf="messages | async as messageData">
        <div class="row">
            <div class="col-xs-3">
                <ul class="legend">
                    <li class="active" as4-tooltip="Exceptions are always shown"><span class="exception"></span> Exceptions</li>
                    <li class="clickable" [ngClass]="{ 'active': filter.filter.showDuplicates }" as4-tooltip="Show duplicate messages" (click)="toggleSearch(); filter.filter.showDuplicates = !filter.filter.showDuplicates"><span class="duplicate"></span> Duplicates</li>
                    <li class="clickable" [ngClass]="{ 'active': filter.filter.showTests }" as4-tooltip="Show test messages" (click)="toggleSearch(); filter.filter.showTests = !filter.filter.showTests"><span class="test"></span> Tests</li>
                </ul>
            </div>
            <div class="col-xs-9" as4-pager [pages]="messageData.pages" [pageTotal]="messageData.messages.length" [total]="messageData.total"
                [page]="messageData.page" (onChangePage)="filter.filter.page = $event; filter.search()"></div>
        </div>
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th></th>
                        <th>Direction</th>
                        <th>Insertion time</th>
                        <th>Message id</th>
                        <th>From party</th>
                        <th>To party</th>
                        <th>Message type</th>
                        <th>Status</th>
                        <th>Operation</th>
                        <th>Content type</th>
                        <th>Pmode</th>
                    </tr>
                </thead>
                <tbody>
                    <ng-container *ngFor="let message of messageData.messages; let i = index">
                        <tr [ngClass]="{ 'danger': message.hasExceptions, 'delivered': message.isDuplicate, 'test': message.isTest }">
                            <td (click)="toggle(message)" class="clickable">
                                <i class="fa" [class.fa-chevron-right]="message !== activeMessage" [class.fa-chevron-down]="message === activeMessage"></i>
                            </td>
                            <td>{{message.direction | todirection}}</td>
                            <td>{{message.insertionTime | todate}}</td>
                            <td>{{message.ebmsMessageId}}</td>
                            <td>{{message.fromParty}}</td>
                            <td>{{message.toParty}}</td>
                            <td>{{message.ebmsMessageType}}</td>
                            <td>{{message.status}}</td>
                            <td>{{message.operation}}</td>
                            <td>{{message.contentType}}</td>
                            <td>
                                <a [routerLink]="['/pmodes', filter.outFilter.direction === '0' ? 'receiving' : 'sending', message.pMode]" [queryParams]="{ compareto: message.hash }">{{message.pMode}}</a>
                            </td>
                        </tr>
                        <tr *ngIf="message === activeMessage">
                            <td colspan="11">
                                <as4-tab>
                                    <div tabitem title="Info">
                                        <p><b>Content type</b>: {{message.contentType}}</p>
                                        <p><b>Modification time</b>: {{message.modificationTime | todate}}</p>
                                        <p><b>ebMS ref to message id</b>: {{!!!message.ebmsRefToMessageId ? 'N/A' : message.ebmsRefToMessageId}}</p>
                                        <p><b>Message body</b>:
                                            <downloadmessagebody [type]="'message'" [direction]="message.direction" [messageId]="message.ebmsMessageId"></downloadmessagebody>
                                        </p>
                                        <p><b>Is test message?</b>: <input type="checkbox" [ngModel]="message.isTest" disabled/></p>
                                        <p><b>Is duplicate message?</b>: <input type="checkbox" [ngModel]="message.isDuplicate"
                                                disabled/></p>
                                        <p><b>Soap envelope</b>:
                                            <as4-clipboard [content]="messageDetail?.soapEnvelope"></as4-clipboard>
                                        </p>
                                    </div>
                                    <div tabitem title="Exceptions" class="exceptions">
                                        <as4-error-message [message]="message" [direction]="+filter.outFilter.direction === 0 ? 1 : 0" target="_blank"></as4-error-message>
                                    </div>
                                    <div tabitem title="Related messages" class="related-messages">
                                        <as4-related-messages [messageId]="message.ebmsMessageId" [direction]="filter.outFilter.direction"></as4-related-messages>
                                    </div>
                                </as4-tab>
                            </td>
                        </tr>
                    </ng-container>
                </tbody>
            </table>
        </div>
        <div class="row">
            <div class="col-xs-3">
                <ul class="legend">
                    <li class="active" as4-tooltip="Exceptions are always shown"><span class="exception"></span> Exceptions</li>
                    <li class="clickable" [ngClass]="{ 'active': filter.filter.showDuplicates }" as4-tooltip="Show duplicate messages" (click)="toggleSearch(); filter.filter.showDuplicates = !filter.filter.showDuplicates"><span class="duplicate"></span> Duplicates</li>
                    <li class="clickable" [ngClass]="{ 'active': filter.filter.showTests }" as4-tooltip="Show test messages" (click)="toggleSearch(); filter.filter.showTests = !filter.filter.showTests"><span class="test"></span> Tests</li>
                </ul>
            </div>
            <div class="col-xs-9" as4-pager [pages]="messageData.pages" [pageTotal]="messageData.messages.length" [total]="messageData.total"
                [page]="messageData.page" (onChangePage)="filter.filter.page = $event; filter.search()"></div>
        </div>
    </div>
</as4-box>